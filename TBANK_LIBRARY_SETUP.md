# Настройка платежной системы Т-Банк с библиотекой tbank-payments

## Что было сделано

1. ✅ Установлена официальная библиотека `tbank-payments` для работы с Т-Банк API
2. ✅ Переписана интеграция с использованием библиотеки (все токены и подписи обрабатываются автоматически)
3. ✅ Форма оплаты уже настроена и собирает необходимые данные
4. ✅ Все методы работы с платежами обновлены

## Что требуется от вас

### 1. Установка зависимостей

Библиотека уже установлена, но если нужно переустановить:

```bash
npm install
```

### 2. Настройка конфигурации

Убедитесь, что в `config.js` или переменных окружения Railway указаны:

```javascript
TINKOFF_TERMINAL_KEY: 'ваш_terminal_key',  // Ключ терминала из личного кабинета Т-Банк
TINKOFF_PASSWORD: 'ваш_secret_key',        // Секретный ключ (Password) из личного кабинета
BASE_URL: 'https://ваш-домен.com'         // URL вашего приложения для вебхуков
```

**Важно:** 
- `TINKOFF_TERMINAL_KEY` - это ключ терминала (TerminalKey)
- `TINKOFF_PASSWORD` - это секретный ключ (SecretKey/Password)
- Эти ключи должны быть из одной пары в личном кабинете Т-Банк

### 3. Настройка вебхуков в личном кабинете Т-Банк

1. Войдите в личный кабинет Т-Банк: https://www.tinkoff.ru/business/acquiring/
2. Перейдите в настройки терминала
3. Укажите URL для уведомлений (webhook):
   ```
   https://ваш-домен.com/api/payment/webhook
   ```
4. Сохраните настройки

### 4. Форма оплаты

Форма оплаты уже настроена и собирает:
- **Email** (необязательно, но рекомендуется для чека)
- **Телефон** (необязательно, но рекомендуется для чека)

**Важно:** Для формирования чека (54-ФЗ) необходимо указать хотя бы Email или Телефон.

### 5. Тестирование

Для тестирования используйте тестовый терминал с приставкой `DEMO`:
- TerminalKey должен заканчиваться на `DEMO` (например: `1769081750006DEMO`)
- Запросы отправляются на боевую среду: `https://securepay.tinkoff.ru/v2/`

**Тестовые карты:**
- Успешная оплата: `4300000000000777` (срок действия: любая будущая дата, CVV: любой)
- Отклоненная оплата: `4300000000000018`

## Структура платежа

При создании платежа библиотека автоматически:

1. ✅ Генерирует токен подписи
2. ✅ Формирует чек для 54-ФЗ (если указан Email или Phone)
3. ✅ Отправляет запрос в Т-Банк
4. ✅ Проверяет подпись ответа
5. ✅ Возвращает URL для перенаправления на оплату

## Методы, используемые в проекте

### `createPayment(paymentData)`
Создает новый платеж и возвращает URL для оплаты.

**Параметры:**
- `amount` - сумма в копейках
- `orderId` - уникальный ID заказа
- `description` - описание платежа
- `customer` - объект с `email` и `phone`
- `items` - массив товаров для чека
- `successUrl` - URL успешной оплаты
- `failureUrl` - URL неуспешной оплаты

### `getPaymentStatus(paymentId)`
Проверяет текущий статус платежа.

### `handleWebhook(webhookData)`
Обрабатывает уведомления от Т-Банк о смене статуса платежа.

### `cancelPayment(paymentId, amount)`
Отменяет платеж полностью или частично.

## Статусы платежей

- `NEW` - Платеж создан
- `FORM_SHOWED` - Показана форма оплаты
- `AUTHORIZING` - Идет авторизация
- `3DS_CHECKING` - Проходит 3-D Secure
- `AUTHORIZED` - Авторизован (требует подтверждения)
- `CONFIRMED` - Подтвержден ✅
- `REJECTED` - Отклонен ❌
- `CANCELED` - Отменен
- `REFUNDED` - Возвращен

## Что происходит при оплате

1. Пользователь заполняет форму (Email/Телефон)
2. Создается заказ в базе данных
3. Создается платеж в Т-Банк через библиотеку
4. Пользователь перенаправляется на страницу оплаты Т-Банк
5. После оплаты Т-Банк отправляет webhook на `/api/payment/webhook`
6. Статус платежа обновляется в базе данных
7. Администратор получает уведомление в Telegram

## Преимущества использования библиотеки

✅ Автоматическая генерация токенов подписи  
✅ Правильная обработка вложенных объектов (Receipt)  
✅ Встроенная проверка подписей ответов  
✅ Обработка ошибок с понятными сообщениями  
✅ Поддержка всех методов Т-Банк API  
✅ Актуальная документация и поддержка  

## Полезные ссылки

- [Документация Т-Банк API](https://developer.tbank.ru/eacq/api)
- [Библиотека tbank-payments на GitHub](https://github.com/esurkov1/tbank-payments)
- [Личный кабинет Т-Банк](https://www.tinkoff.ru/business/acquiring/)

## Поддержка

Если возникли проблемы:
1. Проверьте логи сервера (особенно при DEBUG=true)
2. Убедитесь, что TerminalKey и Password правильные
3. Проверьте, что webhook URL доступен из интернета
4. Убедитесь, что BASE_URL указан правильно
